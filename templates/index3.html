{% extends 'base.html' %}
{% load static %}
{% block title %}GenialTouch - Home{% endblock %}
{% block content %}

<style>
    .ps-block--category img:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    /* Lazy loading styles - will not affect original UI */
    .lazy-loading-placeholder {
        background: linear-gradient(90deg, #f5f5f5 25%, #e8e8e8 50%, #f5f5f5 75%);
        background-size: 400% 100%;
        animation: loading-shimmer 1.5s infinite;
    }
    
    @keyframes loading-shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    
    .lazy-loaded {
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .lazy-loaded.loaded {
        opacity: 1;
    }
    
    .lazy-bg-loaded {
        background-color: #f5f5f5;
    }
</style>

<div id="homepage-1">

    {% comment %}
    <!-- Top Categories -->
    <div class="ps-top-categories">
        <div class="ps-container">
            <h3>Top categories of the month</h3>
            <div class="row">
                {% for category in top_categories %}
                <div class="col-xl-2 col-lg-3 col-md-4 col-sm-4 col-6">
                    <div class="ps-block--category">
                        <a class="ps-block__overlay" href="{{ category.get_absolute_url }}"></a>
                        {% if category.image %}
                        <img src="{{ category.image.url }}" alt="{{ category.name }}"
                        style="width: 100%;
                                height: 100%;
                                object-fit: cover;
                                clip-path: polygon(
                                    25% 6%, 75% 6%,
                                    100% 50%, 75% 94%,
                                    25% 94%, 0% 50%
                                );
                                transition: transform 0.3s ease, box-shadow 0.3s ease;">
                        {% endif %}
                        <p>{{ category.name }}</p>

                        
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endcomment %}


    <div class="ps-deal-of-day" style="margin-top: 25px;">
        <div class="ps-container">
            
            <h3>Top categories of the month</h3>
            <div class="ps-section__content">
                <div class="ps-carousel--nav owl-slider" data-owl-auto="false" data-owl-loop="false" data-owl-speed="10000" data-owl-gap="30" data-owl-nav="true" data-owl-dots="true" data-owl-item="7" data-owl-item-xs="2" data-owl-item-sm="3" data-owl-item-md="4" data-owl-item-lg="5" data-owl-item-xl="6" data-owl-duration="1000" data-owl-mousedrag="on">
                    {% for category in top_categories %}
                    <div class="ps-product ps-product--inner">
                        <div class="ps-block--category">
                            <a class="ps-block__overlay" href="{{ category.get_absolute_url }}"></a>
                            {% if category.image %}
                            <img 
                                src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E" 
                                data-src="{{ category.image.url }}" 
                                alt="{{ category.name }}"
                                class="lazy-loading-placeholder lazy-loaded"
                                loading="lazy"
                                width="150"
                                height="150"
                                style="width: 100%; height: 100%; object-fit: cover; clip-path: polygon(25% 6%, 75% 6%, 100% 50%, 75% 94%, 25% 94%, 0% 50%); transition: transform 0.3s ease, box-shadow 0.3s ease;"
                                onload="this.classList.remove('lazy-loading-placeholder'); this.classList.add('loaded');">
                            {% endif %}
                            <p>{{ category.name }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>



    <!-- Home Banner -->
    <div class="ps-home-banner ps-home-banner--1">
        <div class="ps-container">
            <div class="ps-section__left">
                <div class="ps-carousel--nav-inside owl-slider" data-owl-auto="true" data-owl-loop="true" data-owl-speed="5000" data-owl-gap="0" data-owl-nav="true" data-owl-dots="true" data-owl-item="1" data-owl-item-xs="1" data-owl-item-sm="1" data-owl-item-md="1" data-owl-item-lg="1" data-owl-duration="1000" data-owl-mousedrag="on" data-owl-animate-in="fadeIn" data-owl-animate-out="fadeOut">
                    {% for banner in banners %}
                    <div class="ps-banner lazy-bg-loaded" 
                         style="background-color: #f5f5f5; background-size: cover; background-position: center; min-height: 400px;"
                         data-bg="{{ banner.image.url }}">
                        <a class="ps-banner__overlay" href="{{ banner.url }}"></a>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="ps-section__right">
                {% for promo in promotions|slice:":2" %}
                <a class="ps-collection" href="{{ promo.url }}">
                    <img 
                        src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E" 
                        data-src="{{ promo.image.url }}" 
                        alt="{{ promo.title }}"
                        class="lazy-loading-placeholder lazy-loaded"
                        loading="lazy"
                        width="300"
                        height="150"
                        onload="this.classList.remove('lazy-loading-placeholder'); this.classList.add('loaded');">
                </a>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Site Features -->
    <div class="ps-site-features">
        <div class="ps-container">
            <div class="ps-block--site-features">
                <div class="ps-block__item">
                    <div class="ps-block__left"><i class="icon-rocket"></i></div>
                    <div class="ps-block__right">
                        <h4>Free Delivery</h4>
                        <p>For all orders over {{ currency_symbol }} 99</p>
                    </div>
                </div>
                <div class="ps-block__item">
                    <div class="ps-block__left"><i class="icon-sync"></i></div>
                    <div class="ps-block__right">
                        <h4>90 Days Return</h4>
                        <p>If goods have problems</p>
                    </div>
                </div>
                <div class="ps-block__item">
                    <div class="ps-block__left"><i class="icon-credit-card"></i></div>
                    <div class="ps-block__right">
                        <h4>Secure Payment</h4>
                        <p>100% secure payment</p>
                    </div>
                </div>
                <div class="ps-block__item">
                    <div class="ps-block__left"><i class="icon-bubbles"></i></div>
                    <div class="ps-block__right">
                        <h4>24/7 Support</h4>
                        <p>Dedicated support</p>
                    </div>
                </div>
                <div class="ps-block__item">
                    <div class="ps-block__left"><i class="icon-gift"></i></div>
                    <div class="ps-block__right">
                        <h4>Gift Service</h4>
                        <p>Support gift service</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Deal of the Day -->
    <div class="ps-deal-of-day">
        <div class="ps-container">
            <div class="ps-section__header">
                <div class="ps-block--countdown-deal">
                    <div class="ps-block__left">
                        <h3>Deals of the day</h3>
                    </div>
                    <div class="ps-block__right">
                        <figure>
                            <figcaption>End in:</figcaption>
                            <ul class="ps-countdown" data-time="{{ deal_end_date|date:'F d, Y H:i:s' }}">
                                <li><span class="days"></span></li>
                                <li><span class="hours"></span></li>
                                <li><span class="minutes"></span></li>
                                <li><span class="seconds"></span></li>
                            </ul>
                        </figure>
                    </div>
                </div>
                <a href="{% url 'product_list' %}">View all</a>
            </div>
            <div class="ps-section__content">
                <div class="ps-carousel--nav owl-slider" data-owl-auto="false" data-owl-loop="false" data-owl-speed="10000" data-owl-gap="30" data-owl-nav="true" data-owl-dots="true" data-owl-item="7" data-owl-item-xs="2" data-owl-item-sm="3" data-owl-item-md="4" data-owl-item-lg="5" data-owl-item-xl="6" data-owl-duration="1000" data-owl-mousedrag="on">
                    {% for product in deals %}
                    <div class="ps-product ps-product--inner">
                        <div class="ps-product__thumbnail">
                            <a href="{{ product.get_absolute_url }}">
                                {% with product.images.first as first_image %}
                                {% if first_image %}
                                <img 
                                    src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E" 
                                    data-src="{{ first_image.image.url }}" 
                                    alt="{{ product.name }}"
                                    class="lazy-loading-placeholder lazy-loaded"
                                    loading="lazy"
                                    width="300"
                                    height="300"
                                    onload="this.classList.remove('lazy-loading-placeholder'); this.classList.add('loaded');">
                                {% endif %}
                                {% endwith %}
                            </a>
                            {% if product.discount_price %}
                            <div class="ps-product__badge">-{{ product.get_discount_percentage }}%</div>
                            {% endif %}

                            {% comment %}
                            <ul class="ps-product__actions">
                                <li>
                                    <a href="#" data-toggle="tooltip" data-placement="top" title="Add To Cart" 
                                       data-product-id="{{ product.id }}" class="add-to-cart">
                                        <i class="icon-bag2"></i>
                                    </a>
                                </li>
                                <li>
                                    <a href="#" data-placement="top" title="Quick View" 
                                       data-toggle="modal" data-target="#product-quickview" 
                                       data-product-id="{{ product.id }}" class="quick-view">
                                        <i class="icon-eye"></i>
                                    </a>
                                </li>
                                <li>
                                    <a href="#" data-toggle="tooltip" data-placement="top" 
                                       title="Add to Wishlist" data-product-id="{{ product.id }}" 
                                       class="add-to-wishlist">
                                        <i class="icon-heart"></i>
                                    </a>
                                </li>
                                
                                <li>
                                    <a href="#" data-toggle="tooltip" data-placement="top" 
                                       title="Compare" data-product-id="{{ product.id }}" 
                                       class="add-to-compare">
                                        <i class="icon-chart-bars"></i>
                                    </a>
                                </li>
                               
                            </ul>
                            {% endcomment %}
                        </div>
                        
                        <div class="ps-product__container">
                            {% if product.discount_price %}
                            <p class="ps-product__price sale">
                                {{ currency_symbol }} {{ product.discount_price }} 
                                <del>{{ currency_symbol }} {{ product.price }}</del>
                                <br>
                                <small>{{ product.get_discount_percentage }}% off</small>
                            </p>
                            {% else %}
                            <p class="ps-product__price">{{ currency_symbol }} {{ product.price }}</p>
                            {% endif %}
                            <div class="ps-product__content">
                                <a class="ps-product__title" href="{{ product.get_absolute_url }}">
                                    {{ product.name }}
                                </a>
                                
                                
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Home Ads -->
    <div class="ps-home-ads">
        <div class="ps-container">
            <div class="row">
                {% for ad in home_ads|slice:":3" %}
                <div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 col-12">
                    <a class="ps-collection" href="{{ ad.url }}">
                        <img 
                            src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E" 
                            data-src="{{ ad.image.url }}" 
                            alt="{{ ad.title }}"
                            class="lazy-loading-placeholder lazy-loaded"
                            loading="lazy"
                            width="400"
                            height="200"
                            onload="this.classList.remove('lazy-loading-placeholder'); this.classList.add('loaded');">
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    

    

    <!-- Replace the Consumer Electronics, Apparels & Clothing, and Home, Garden & Kitchen sections with this: -->
    {% for category_data in category_products %}
    <div class="ps-product-list ps-clothings">
        <div class="ps-container">
            <div class="ps-section__header">
                <h3>{{ category_data.category.name }}</h3>
                <ul class="ps-section__links">
                    <li><a href="{{ category_data.category.get_absolute_url }}?sort=newest">New Arrivals</a></li>
                    <li><a href="{{ category_data.category.get_absolute_url }}?sort=bestseller">Best seller</a></li>
                    <li><a href="{{ category_data.category.get_absolute_url }}?sort=popular">Most Popular</a></li>
                    <li><a href="{{ category_data.category.get_absolute_url }}">View All</a></li>
                </ul>
            </div>
            <div class="ps-section__content">
                <div class="ps-carousel--nav owl-slider" data-owl-auto="false" data-owl-loop="false" data-owl-speed="10000" data-owl-gap="0" data-owl-nav="true" data-owl-dots="true" data-owl-item="7" data-owl-item-xs="2" data-owl-item-sm="2" data-owl-item-md="3" data-owl-item-lg="4" data-owl-item-xl="6" data-owl-duration="1000" data-owl-mousedrag="on">
                    {% for product in category_data.products %}
                    <div class="ps-product">
                        <div class="ps-product__thumbnail">
                            <a href="{{ product.get_absolute_url }}">
                                {% with product.images.first as first_image %}
                                {% if first_image %}
                                <img 
                                    src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E" 
                                    data-src="{{ first_image.image.url }}" 
                                    alt="{{ product.name }}"
                                    class="lazy-loading-placeholder lazy-loaded"
                                    loading="lazy"
                                    width="300"
                                    height="300"
                                    onload="this.classList.remove('lazy-loading-placeholder'); this.classList.add('loaded');" />
                                {% endif %}
                                {% endwith %}
                            </a>
                            {% if product.discount_price %}
                            <div class="ps-product__badge">-{{ product.get_discount_percentage }}%</div>
                            {% endif %}

                            {% comment %}
                            <ul class="ps-product__actions">
                                <li>
                                    <a href="#" data-toggle="tooltip" data-placement="top" title="Add To Cart" 
                                    data-product-id="{{ product.id }}" class="add-to-cart">
                                        <i class="icon-bag2"></i>
                                    </a>
                                </li>
                                <li>
                                    <a href="#" data-placement="top" title="Quick View" 
                                    data-toggle="modal" data-target="#product-quickview" 
                                    data-product-id="{{ product.id }}" class="quick-view">
                                        <i class="icon-eye"></i>
                                    </a>
                                </li>
                                <li>
                                    <a href="#" data-toggle="tooltip" data-placement="top" 
                                    title="Add to Wishlist" data-product-id="{{ product.id }}" 
                                    class="add-to-wishlist">
                                        <i class="icon-heart"></i>
                                    </a>
                                </li>
                                <li>
                                    <a href="#" data-toggle="tooltip" data-placement="top" 
                                    title="Compare" data-product-id="{{ product.id }}" 
                                    class="add-to-compare">
                                        <i class="icon-chart-bars"></i>
                                    </a>
                                </li>
                            </ul>
                            {% endcomment %}
                        </div>
                        <div class="ps-product__container">
                            {% if product.brand %}
                            <a class="ps-product__vendor" href="{{ product.brand.get_absolute_url }}">
                                {{ product.brand.name }}
                            </a>
                            {% endif %}
                            <div class="ps-product__content">
                                <a class="ps-product__title" href="{{ product.get_absolute_url }}">
                                    {{ product.name }}
                                </a>
                                
                                {% if product.discount_price %}
                                <p class="ps-product__price sale">{{ currency_symbol }} {{ product.discount_price }} <del>{{ currency_symbol }} {{ product.price }}</del></p>
                                {% else %}
                                <p class="ps-product__price">{{ currency_symbol }} {{ product.price }}</p>
                                {% endif %}
                            </div>
                            <div class="ps-product__content hover">
                                <a class="ps-product__title" href="{{ product.get_absolute_url }}">
                                    {{ product.name }}
                                </a>
                                {% if product.discount_price %}
                                <p class="ps-product__price sale">{{ currency_symbol }} {{ product.discount_price }} <del>{{ currency_symbol }} {{ product.price }}</del></p>
                                {% else %}
                                <p class="ps-product__price">{{ currency_symbol }} {{ product.price }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Home Ads 2 -->
    <div class="ps-home-ads">
        <div class="ps-container">
            <div class="row">
                {% for ad in home_ads|slice:"3:5" %}
                <div class="col-xl-{% if forloop.first %}8{% else %}4{% endif %} col-lg-{% if forloop.first %}8{% else %}4{% endif %} col-md-12 col-sm-12 col-12">
                    <a class="ps-collection" href="{{ ad.url }}">
                        <img 
                            src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E" 
                            data-src="{{ ad.image.url }}" 
                            alt="{{ ad.title }}"
                            class="lazy-loading-placeholder lazy-loaded"
                            loading="lazy"
                            width="{% if forloop.first %}800{% else %}400{% endif %}"
                            height="200"
                            onload="this.classList.remove('lazy-loading-placeholder'); this.classList.add('loaded');">
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Download App -->
    <div class="ps-download-app">
        <div class="ps-container">
            <div class="ps-block--download-app">
                <div class="container">
                    <div class="row">
                        <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-12">
                            <div class="ps-block__thumbnail">
                                <img 
                                    src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E" 
                                    data-src="{% static 'downloadapp.png' %}" 
                                    alt="Download App"
                                    class="lazy-loading-placeholder lazy-loaded"
                                    loading="lazy"
                                    width="400"
                                    height="300"
                                    onload="this.classList.remove('lazy-loading-placeholder'); this.classList.add('loaded');">
                            </div>
                        </div>
                        <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-12">
                            <div class="ps-block__content">
                                <h3>Download GenialTouch App Now!</h3>
                                <p>Shopping fastly and easily more with our app. Get a link to download the app on your phone</p>
                                <form class="ps-form--download-app" action="" method="post">
                                    {% csrf_token %}
                                    <div class="form-group--nest">
                                        <input class="form-control" type="email" name="email" placeholder="Email Address" required>
                                        <button class="ps-btn" type="submit">Subscribe</button>
                                    </div>
                                </form>
                                <p class="download-link">
                                    <a href="#">
                                        <img 
                                            src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E" 
                                            data-src="{% static 'img/google-play.png' %}" 
                                            alt="Google Play"
                                            class="lazy-loading-placeholder lazy-loaded"
                                            loading="lazy"
                                            width="135"
                                            height="40"
                                            onload="this.classList.remove('lazy-loading-placeholder'); this.classList.add('loaded');">
                                    </a>
                                    <a href="#">
                                        <img 
                                            src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E" 
                                            data-src="{% static 'img/app-store.png' %}" 
                                            alt="App Store"
                                            class="lazy-loading-placeholder lazy-loaded"
                                            loading="lazy"
                                            width="135"
                                            height="40"
                                            onload="this.classList.remove('lazy-loading-placeholder'); this.classList.add('loaded');">
                                    </a>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Arrivals -->
    <div class="ps-product-list ps-new-arrivals">
        <div class="ps-container">
            <div class="ps-section__header">
                <h3>Hot New Arrivals</h3>
                <ul class="ps-section__links">
                    <li><a href="{% url 'product_list' %}?category=technology&sort=newest">Technologies</a></li>
                    <li><a href="{% url 'product_list' %}?category=electronics&sort=newest">Electronic</a></li>
                    <li><a href="{% url 'product_list' %}?category=furniture&sort=newest">Furnitures</a></li>
                    <li><a href="{% url 'product_list' %}?category=clothing&sort=newest">Clothing & Apparel</a></li>
                    <li><a href="{% url 'product_list' %}?category=beauty&sort=newest">Health & Beauty</a></li>
                    <li><a href="{% url 'product_list' %}?sort=newest">View All</a></li>
                </ul>
            </div>
            <div class="ps-section__content">
                <div class="row">
                    {% for product in new_arrivals|slice:":8" %}
                    <div class="col-xl-3 col-lg-4 col-md-4 col-sm-6 col-12">
                        <div class="ps-product--horizontal">
                            <div class="ps-product__thumbnail">
                                <a href="{{ product.get_absolute_url }}">
                                    {% with product.images.first as first_image %}
                                    {% if first_image %}
                                    <img 
                                        src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E" 
                                        data-src="{{ first_image.image.url }}" 
                                        alt="{{ product.name }}"
                                        class="lazy-loading-placeholder lazy-loaded"
                                        loading="lazy"
                                        width="100"
                                        height="100"
                                        onload="this.classList.remove('lazy-loading-placeholder'); this.classList.add('loaded');" />
                                    {% endif %}
                                    {% endwith %}
                                </a>
                            </div>
                            <div class="ps-product__content">
                                <a class="ps-product__title" href="{{ product.get_absolute_url }}">
                                    {{ product.name }}
                                </a>
                                <p class="ps-product__price">
                                    {% if product.discount_price %}
                                    <span class="sale">{{ currency_symbol }} {{ product.discount_price }}</span>
                                    <del>{{ currency_symbol }} {{ product.price }}</del>
                                    {% else %}
                                    {{ currency_symbol }} {{ product.price }}
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Newsletter -->
    <div class="ps-newsletter">
        <div class="ps-container">
            <form class="ps-form--newsletter" action="" method="post">
                {% csrf_token %}
                <div class="row">
                    <div class="col-xl-5 col-lg-12 col-md-12 col-sm-12 col-12">
                        <div class="ps-form__left">
                            <h3>Newsletter</h3>
                            <p>Subscribe to get information about products and coupons</p>
                        </div>
                    </div>
                    <div class="col-xl-7 col-lg-12 col-md-12 col-sm-12 col-12">
                        <div class="ps-form__right">
                            <div class="form-group--nest">
                                <input class="form-control" type="email" name="email" placeholder="Email address" required>
                                <button class="ps-btn" type="submit">Subscribe</button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Enhanced Lazy Loading with Intersection Observer
document.addEventListener('DOMContentLoaded', function() {
    // Elements to lazy load
    const lazyImages = document.querySelectorAll('img.lazy-loaded');
    const lazyBackgrounds = document.querySelectorAll('.lazy-bg-loaded[data-bg]');
    const carousels = document.querySelectorAll('.owl-slider');
    
    // Function to load image
    function loadImage(img) {
        if (img.dataset.src) {
            img.src = img.dataset.src;
            img.classList.remove('lazy-loading-placeholder');
            img.classList.add('loaded');
            
            // Also remove inline loading animation if it exists
            img.style.background = 'none';
        }
    }
    
    // Function to load background
    function loadBackground(bg) {
        if (bg.dataset.bg) {
            bg.style.backgroundImage = `url('${bg.dataset.bg}')`;
            bg.classList.remove('lazy-bg-loaded');
        }
    }
    
    // Check if element is in viewport
    function isInViewport(element, offset = 0) {
        const rect = element.getBoundingClientRect();
        return (
            rect.top <= (window.innerHeight || document.documentElement.clientHeight) + offset &&
            rect.bottom >= 0 - offset &&
            rect.left <= (window.innerWidth || document.documentElement.clientWidth) + offset &&
            rect.right >= 0 - offset
        );
    }
    
    // Load visible elements
    function loadVisibleElements() {
        // Load visible images
        lazyImages.forEach(img => {
            if (!img.classList.contains('loaded') && isInViewport(img, 300)) {
                loadImage(img);
            }
        });
        
        // Load visible backgrounds
        lazyBackgrounds.forEach(bg => {
            if (isInViewport(bg, 500)) {
                loadBackground(bg);
            }
        });
    }
    
    // Initialize lazy loading
    if ('IntersectionObserver' in window) {
        // Image observer
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    loadImage(entry.target);
                    observer.unobserve(entry.target);
                }
            });
        }, {
            rootMargin: '200px',
            threshold: 0.01
        });
        
        lazyImages.forEach(img => imageObserver.observe(img));
        
        // Background observer
        const bgObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    loadBackground(entry.target);
                    observer.unobserve(entry.target);
                }
            });
        }, {
            rootMargin: '300px',
            threshold: 0.01
        });
        
        lazyBackgrounds.forEach(bg => bgObserver.observe(bg));
        
        // Carousel lazy initialization observer
        const carouselObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const carousel = entry.target;
                    if (window.$ && $.fn.owlCarousel && !$(carousel).hasClass('owl-loaded')) {
                        // Initialize carousel with optimized settings
                        setTimeout(() => {
                            if ($(carousel).length && !$(carousel).hasClass('owl-loaded')) {
                                $(carousel).owlCarousel({
                                    items: carousel.dataset.owlItem || 4,
                                    loop: carousel.dataset.owlLoop === 'true',
                                    margin: parseInt(carousel.dataset.owlGap) || 30,
                                    nav: carousel.dataset.owlNav === 'true',
                                    dots: carousel.dataset.owlDots === 'true',
                                    lazyLoad: true,
                                    autoplay: carousel.dataset.owlAuto === 'true',
                                    autoplayTimeout: parseInt(carousel.dataset.owlSpeed) || 5000,
                                    responsive: {
                                        0: { items: carousel.dataset.owlItemXs || 1 },
                                        576: { items: carousel.dataset.owlItemSm || 2 },
                                        768: { items: carousel.dataset.owlItemMd || 3 },
                                        992: { items: carousel.dataset.owlItemLg || 4 },
                                        1200: { items: carousel.dataset.owlItemXl || 6 }
                                    }
                                });
                            }
                        }, 100);
                    }
                    carouselObserver.unobserve(carousel);
                }
            });
        }, {
            rootMargin: '400px',
            threshold: 0.01
        });
        
        carousels.forEach(carousel => carouselObserver.observe(carousel));
        
    } else {
        // Fallback for older browsers - load all on scroll
        window.addEventListener('scroll', function() {
            loadVisibleElements();
        });
        
        // Initial load
        loadVisibleElements();
    }
    
    // Load all images after 3 seconds (fallback for any missed)
    setTimeout(function() {
        lazyImages.forEach(img => {
            if (!img.classList.contains('loaded')) {
                loadImage(img);
            }
        });
        
        lazyBackgrounds.forEach(bg => {
            loadBackground(bg);
        });
    }, 3000);
    
    // Ensure carousels initialize even if Intersection Observer misses them
    setTimeout(function() {
        if (window.$ && $.fn.owlCarousel) {
            $('.owl-slider').each(function() {
                if (!$(this).hasClass('owl-loaded')) {
                    $(this).owlCarousel({
                        items: $(this).data('owl-item') || 4,
                        loop: $(this).data('owl-loop') || false,
                        margin: parseInt($(this).data('owl-gap')) || 30,
                        nav: $(this).data('owl-nav') !== false,
                        dots: $(this).data('owl-dots') !== false,
                        lazyLoad: true,
                        autoplay: $(this).data('owl-auto') || false,
                        autoplayTimeout: parseInt($(this).data('owl-speed')) || 5000,
                        responsive: {
                            0: { items: $(this).data('owl-item-xs') || 1 },
                            576: { items: $(this).data('owl-item-sm') || 2 },
                            768: { items: $(this).data('owl-item-md') || 3 },
                            992: { items: $(this).data('owl-item-lg') || 4 },
                            1200: { items: $(this).data('owl-item-xl') || 6 }
                        }
                    });
                }
            });
        }
    }, 2000);
});
</script>
{% endblock %}