{% extends 'base.html' %}
{% load static %}
{% block title %}GenialTouch - Home{% endblock %}
{% block content %}

<style>
    /* Loading spinner styles */
    .loading-spinner {
        text-align: center;
        padding: 40px;
        display: none;
    }
    
    .loading-spinner.active {
        display: block;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #ff6b6b;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .section-placeholder {
        height: 400px;
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 8px;
        margin: 20px 0;
    }
    
    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }
    
    /* Original styles from your index */
    .ps-block--category img:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .lazy-image {
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .lazy-image.loaded {
        opacity: 1;
    }
    
    .lazy-placeholder {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }
    
    .view-all-btn {
        display: inline-block;
        padding: 10px 20px;
        background: #ff6b6b;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        font-weight: bold;
        transition: background 0.3s;
        text-align: center;
        margin-top: 15px;
    }
    
    .view-all-btn:hover {
        background: #ff5252;
        color: white;
        text-decoration: none;
    }
    
    .view-all-btn-container {
        text-align: center;
        margin-top: 20px;
        margin-bottom: 30px;
    }
</style>


<div id="homepage-1">
    <!-- Top Categories Slider (Loaded immediately) -->
    <div class="ps-deal-of-day" style="margin-top: 25px; padding-bottom: 0px;">
        <div class="ps-container">
            <h3>Top categories of the month</h3>
            <div class="ps-section__content">
                <div class="ps-carousel--nav owl-slider" data-owl-auto="false" data-owl-loop="false" data-owl-speed="10000" data-owl-gap="30" data-owl-nav="true" data-owl-dots="true" data-owl-item="7" data-owl-item-xs="2" data-owl-item-sm="3" data-owl-item-md="4" data-owl-item-lg="5" data-owl-item-xl="6" data-owl-duration="1000" data-owl-mousedrag="on">
                    {% for category in top_categories %}
                    <div class="ps-product ps-product--inner">
                        <div class="ps-block--category">
                            <a class="ps-block__overlay" href="{% url 'products_by_category' category.slug %}"></a>
                            {% if category.image %}
                            <img class="lazy-image" 
                                 data-src="{{ category.image.url }}" 
                                 src="{% static 'img/placeholder.webp' %}"
                                 alt="{{ category.name }}"
                                 style="width: 100%;
                                        height: 100%;
                                        object-fit: cover;
                                        clip-path: polygon(
                                            25% 6%, 75% 6%,
                                            100% 50%, 75% 94%,
                                            25% 94%, 0% 50%
                                        );
                                        transition: transform 0.3s ease, box-shadow 0.3s ease;">
                            {% endif %}
                            <p>{{ category.name }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Home Banner (Loaded immediately) -->
    <div class="ps-home-banner ps-home-banner--1">
        <div class="ps-container">
            <div class="ps-section__left">
                <div class="ps-carousel--nav-inside owl-slider" data-owl-auto="true" data-owl-loop="true" data-owl-speed="5000" data-owl-gap="0" data-owl-nav="true" data-owl-dots="true" data-owl-item="1" data-owl-item-xs="1" data-owl-item-sm="1" data-owl-item-md="1" data-owl-item-lg="1" data-owl-duration="1000" data-owl-mousedrag="on" data-owl-animate-in="fadeIn" data-owl-animate-out="fadeOut">
                    {% for banner in banners %}
                    <div class="ps-banner bg--cover lazy-placeholder" data-background="{{ banner.image.url }}">
                        <img class="lazy-image" 
                             data-src="{{ banner.image.url }}" 
                             src="{% static 'img/banner-placeholder.webp' %}"
                             style="display: none;">
                        <a class="ps-banner__overlay" href="{{ banner.url }}"></a>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="ps-section__right">
                {% for promo in promotions %}
                <a class="ps-collection" href="{{ promo.url }}">
                    <img class="lazy-image" 
                         data-src="{{ promo.image.url }}" 
                         src="{% static 'img/ads-placeholder.webp' %}"
                         alt="{{ promo.title }}">
                </a>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Site Features (Loaded immediately) -->
    <div class="ps-site-features">
        <div class="ps-container">
            <div class="ps-block--site-features">
                {% for feature in site_features %}
                <div class="ps-block__item">
                    <div class="ps-block__left">
                        <i class="{{ feature.icon }}"></i>
                    </div>
                    <div class="ps-block__right">
                        <h4>{{ feature.title }}</h4>
                        <p>
                            {% if feature.min_order_amount %}
                                For all orders over {{ currency_symbol }} {{ feature.min_order_amount }}
                            {% elif feature.return_days %}
                                If goods have problems within {{ feature.return_days }} days
                            {% else %}
                                {{ feature.description }}
                            {% endif %}
                        </p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Dynamic Content Container (Loaded via AJAX) -->
    <div id="dynamic-content">
        
        <!-- Placeholders for sections to be loaded -->
         <!-- Deal of the Day -->
        <div class="ps-deal-of-day">
            <div class="ps-container">
                <div class="ps-section__header">
                    <div class="ps-block--countdown-deal">
                        <div class="ps-block__left">
                            <h3>Deals of the day</h3>
                        </div>
                        <div class="ps-block__right">
                            <figure>
                                <figcaption>End in:</figcaption>
                                <ul class="ps-countdown" data-time="{{ deal_end_date|date:'F d, Y H:i:s' }}">
                                    <li><span class="days"></span></li>
                                    <li><span class="hours"></span></li>
                                    <li><span class="minutes"></span></li>
                                    <li><span class="seconds"></span></li>
                                </ul>
                            </figure>
                        </div>
                    </div>
                    <a href="{% url 'product_list' %}?featured=true" class="view-all-btn">View all</a>
                </div>
                <div class="ps-section__content">
                    <div class="ps-carousel--nav owl-slider" data-owl-auto="false" data-owl-loop="false" data-owl-speed="10000" data-owl-gap="30" data-owl-nav="true" data-owl-dots="true" data-owl-item="7" data-owl-item-xs="2" data-owl-item-sm="3" data-owl-item-md="4" data-owl-item-lg="5" data-owl-item-xl="6" data-owl-duration="1000" data-owl-mousedrag="on">
                        <div id="deals-container">
                        <div class="section-placeholder" id="deals-placeholder"></div>
                        </div>

                    </div>
                    
                    <!-- View All Deals Button -->
                    <div class="view-all-btn-container">
                        <a href="{% url 'product_list' %}?featured=true" class="view-all-btn">
                            View All Deals
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section-placeholder" id="ads1-placeholder"></div>

        {% for category in featured_categories %}
        <div class="ps-deal-of-day">
            <div class="ps-container">
                <div class="ps-section__header">
                    <div class="ps-block--countdown-deal">
                        <div class="ps-block__left">
                            <h3>{{ category.name }}</h3>
                        </div>
                    </div>
                    <a href="{% url 'products_by_category' category.slug %}" class="view-all-btn">View all</a>
                </div>
                <div class="ps-section__content">
                    <div class="ps-carousel--nav owl-slider" data-owl-auto="false" data-owl-loop="false" data-owl-speed="10000" data-owl-gap="30" data-owl-nav="true" data-owl-dots="true" data-owl-item="7" data-owl-item-xs="2" data-owl-item-sm="3" data-owl-item-md="4" data-owl-item-lg="5" data-owl-item-xl="6" data-owl-duration="1000" data-owl-mousedrag="on">
                        <div id="category-container-{{category.id}}">
                            <div class="section-placeholder" id="category-placeholder-{{ category.id }}"></div>
                        </div>
                    </div>
                    
                    <!-- View All Deals Button -->
                    <div class="view-all-btn-container">
                        <a href="{{ category.get_absolute_url }}" class="view-all-btn">
                            View All
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        
        

        <div class="section-placeholder" id="ads2-placeholder"></div>
        <div class="section-placeholder" id="new-arrivals-placeholder"></div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loading-spinner">
        <div class="spinner"></div>
        <p>Loading more products...</p>
    </div>
</div>

{% endblock %}

{% block extra_js %}

<script>
// Lazy Image Loader (exactly as your original)
    class LazyImageLoader {
        constructor() {
            this.images = document.querySelectorAll('.lazy-image');
            this.init();
        }
        
        init() {
            if ('IntersectionObserver' in window) {
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            this.loadImage(img);
                            observer.unobserve(img);
                        }
                    });
                });
                
                this.images.forEach(img => imageObserver.observe(img));
            } else {
                this.loadAllImages();
            }
        }
        
        loadImage(img) {
            const src = img.dataset.src;
            if (!src) return;
            
            const tempImg = new Image();
            tempImg.onload = () => {
                img.src = src;
                img.classList.add('loaded');
            };
            tempImg.onerror = () => {
                img.src = '/static/img/no-image.jpg';
                img.classList.add('loaded');
            };
            tempImg.src = src;
        }
        
        loadAllImages() {
            this.images.forEach(img => this.loadImage(img));
        }
    }

// Progressive Loading Manager
class ProgressiveLoader {
    constructor() {
        this.sectionsToLoad = [
            { name: 'deals', url: '/load-deals-section/', placeholder: 'deals-placeholder', loaded: false },
            { name: 'ads1', url: '/load-home-ads-section/?section=first', placeholder: 'ads1-placeholder', loaded: false },
            // { name: 'categories', url: '/load-category-products-section/?category=first', placeholder: 'category-placeholder', loaded: false },
            {% for category in featured_categories %}
            { name: 'category_{{ category.id }}', 
              url: '{% url "load_category_products_section" category.slug %}', 
              placeholder: 'category-placeholder-{{ category.id }}', 
              loaded: false },
            {% endfor %}
            { name: 'ads2', url: '/load-home-ads-section/?section=second', placeholder: 'ads2-placeholder', loaded: false },
            { name: 'newarrivals', url: '/load-new-arrivals-section/', placeholder: 'new-arrivals-placeholder', loaded: false }
        ];
        
        this.isLoading = false;
        this.init();
    }
    
    init() {
        if ('IntersectionObserver' in window) {
            this.setupIntersectionObserver();
        } else {
            this.loadAllSections();
        }
    }
    
    setupIntersectionObserver() {
        const options = {
            root: null,
            rootMargin: '200px',
            threshold: 0.1
        };
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const sectionId = entry.target.id;
                    this.loadSection(sectionId);
                    observer.unobserve(entry.target);
                }
            });
        }, options);
        
        this.sectionsToLoad.forEach(section => {
            const element = document.getElementById(section.placeholder);
            if (element && !section.loaded) {
                observer.observe(element);
            }
        });
    }
    
    // loadSection(sectionId) {
    //     const section = this.sectionsToLoad.find(s => s.placeholder === sectionId);
        
    //     if (!section || section.loaded || this.isLoading) return;
        
    //     this.isLoading = true;
    //     document.getElementById('loading-spinner').classList.add('active');
        
    //     fetch(section.url)
    //         .then(response => response.json())
    //         .then(data => {
    //             const placeholder = document.getElementById(section.placeholder);
                
    //             if (placeholder && data.html) {
    //                 // For deals section, insert the products INSIDE the carousel wrapper
    //                 if (section.name === 'deals') {
    //                     // Get the parent carousel container
    //                     const carouselContainer = placeholder.closest('.owl-slider');
    //                     if (carouselContainer) {
    //                         // Remove the placeholder
    //                         placeholder.remove();
    //                         // Insert the products HTML directly into the carousel
    //                         carouselContainer.innerHTML = data.html;
    //                     } else {
    //                         placeholder.outerHTML = data.html;
    //                     }
    //                 } else {
    //                     placeholder.outerHTML = data.html;
    //                 }
                    
    //                 section.loaded = true;
                    
    //                 // Reinitialize carousels
    //                 setTimeout(() => {
    //                     if (typeof $ !== 'undefined') {
    //                         // Destroy and reinitialize the specific carousel
    //                         $('.owl-slider').each(function() {
    //                             if ($(this).hasClass('owl-loaded')) {
    //                                 $(this).owlCarousel('destroy');
    //                             }
    //                             $(this).owlCarousel({
    //                                 loop: $(this).data('owl-loop') || false,
    //                                 margin: $(this).data('owl-gap') || 0,
    //                                 nav: $(this).data('owl-nav') || false,
    //                                 dots: $(this).data('owl-dots') || false,
    //                                 autoplay: $(this).data('owl-auto') || false,
    //                                 autoplayTimeout: $(this).data('owl-speed') || 5000,
    //                                 responsive: {
    //                                     0: { items: $(this).data('owl-item-xs') || 1 },
    //                                     576: { items: $(this).data('owl-item-sm') || 2 },
    //                                     768: { items: $(this).data('owl-item-md') || 3 },
    //                                     992: { items: $(this).data('owl-item-lg') || 4 },
    //                                     1200: { items: $(this).data('owl-item-xl') || 5 }
    //                                 }
    //                             });
    //                         });
                            
    //                         // Reinitialize countdown timers
    //                         $('.ps-countdown').each(function() {
    //                             const endTime = new Date($(this).data('time')).getTime();
                                
    //                             function updateCountdown() {
    //                                 const now = new Date().getTime();
    //                                 const distance = endTime - now;
                                    
    //                                 if (distance < 0) {
    //                                     clearInterval(countdownInterval);
    //                                     $(this).html('<span>Expired</span>');
    //                                     return;
    //                                 }
                                    
    //                                 const days = Math.floor(distance / (1000 * 60 * 60 * 24));
    //                                 const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    //                                 const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    //                                 const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                                    
    //                                 $(this).find('.days').text(days.toString().padStart(2, '0'));
    //                                 $(this).find('.hours').text(hours.toString().padStart(2, '0'));
    //                                 $(this).find('.minutes').text(minutes.toString().padStart(2, '0'));
    //                                 $(this).find('.seconds').text(seconds.toString().padStart(2, '0'));
    //                             }
                                
    //                             updateCountdown.call(this);
    //                             const countdownInterval = setInterval(updateCountdown.bind(this), 1000);
    //                         });
    //                     }
                        
    //                     // CRITICAL FIX: Reinitialize lazy loading for new images
    //                     if (window.lazyLoader) {
    //                         // Update the images collection with newly added images
    //                         window.lazyLoader.images = document.querySelectorAll('.lazy-image:not(.loaded)');
                            
    //                         // Re-initialize the observer for new images
    //                         if ('IntersectionObserver' in window) {
    //                             const imageObserver = new IntersectionObserver((entries, observer) => {
    //                                 entries.forEach(entry => {
    //                                     if (entry.isIntersecting) {
    //                                         const img = entry.target;
    //                                         window.lazyLoader.loadImage(img);
    //                                         observer.unobserve(img);
    //                                     }
    //                                 });
    //                             });
                                
    //                             window.lazyLoader.images.forEach(img => imageObserver.observe(img));
    //                         } else {
    //                             // Fallback: load all images immediately
    //                             window.lazyLoader.images.forEach(img => window.lazyLoader.loadImage(img));
    //                         }
    //                     } else {
    //                         // If lazyLoader doesn't exist for some reason, create it
    //                         window.lazyLoader = new LazyImageLoader();
    //                     }
                        
    //                     // Also trigger a manual load for images that might already be in viewport
    //                     setTimeout(() => {
    //                         const visibleImages = document.querySelectorAll('.lazy-image:not(.loaded)');
    //                         visibleImages.forEach(img => {
    //                             const rect = img.getBoundingClientRect();
    //                             if (rect.top < window.innerHeight && rect.bottom > 0) {
    //                                 if (window.lazyLoader && window.lazyLoader.loadImage) {
    //                                     window.lazyLoader.loadImage(img);
    //                                 } else {
    //                                     // Fallback direct loading
    //                                     const src = img.dataset.src;
    //                                     if (src) {
    //                                         img.src = src;
    //                                         img.classList.add('loaded');
    //                                     }
    //                                 }
    //                             }
    //                         });
    //                     }, 200);
                        
    //                 }, 100);
    //             }
                
    //             this.isLoading = false;
    //             document.getElementById('loading-spinner').classList.remove('active');
    //         })
    //         .catch(error => {
    //             console.error('Error loading section:', error);
    //             this.isLoading = false;
    //             document.getElementById('loading-spinner').classList.remove('active');
    //         });
    // }
    loadSection(sectionId) {
        const section = this.sectionsToLoad.find(s => s.placeholder === sectionId);
        
        if (!section || section.loaded || this.isLoading) return;
        
        this.isLoading = true;
        document.getElementById('loading-spinner').classList.add('active');
        
        fetch(section.url)
            .then(response => response.json())
            .then(data => {
                const placeholder = document.getElementById(section.placeholder);
                
                if (placeholder && data.html) {
                    // Check if this is a category section (starts with 'category_') or deals section
                    if (section.name.startsWith('category_') || section.name === 'deals') {
                        // Get the parent carousel container
                        const carouselContainer = placeholder.closest('.owl-slider');
                        if (carouselContainer) {
                            // Remove the placeholder
                            placeholder.remove();
                            // Insert the products HTML directly into the carousel
                            carouselContainer.innerHTML = data.html;
                        } else {
                            placeholder.outerHTML = data.html;
                        }
                    }
                    // For other sections (ads, new arrivals)
                    else {
                        placeholder.outerHTML = data.html;
                    }
                    
                    section.loaded = true;
                    
                    // Reinitialize carousels
                    setTimeout(() => {
                        if (typeof $ !== 'undefined') {
                            // Destroy and reinitialize the specific carousel
                            $('.owl-slider').each(function() {
                                if ($(this).hasClass('owl-loaded')) {
                                    $(this).owlCarousel('destroy');
                                }
                                $(this).owlCarousel({
                                    loop: $(this).data('owl-loop') || false,
                                    margin: $(this).data('owl-gap') || 0,
                                    nav: $(this).data('owl-nav') || false,
                                    dots: $(this).data('owl-dots') || false,
                                    autoplay: $(this).data('owl-auto') || false,
                                    autoplayTimeout: $(this).data('owl-speed') || 5000,
                                    responsive: {
                                        0: { items: $(this).data('owl-item-xs') || 1 },
                                        576: { items: $(this).data('owl-item-sm') || 2 },
                                        768: { items: $(this).data('owl-item-md') || 3 },
                                        992: { items: $(this).data('owl-item-lg') || 4 },
                                        1200: { items: $(this).data('owl-item-xl') || 5 }
                                    }
                                });
                            });
                            
                            // Reinitialize countdown timers
                            $('.ps-countdown').each(function() {
                                const endTime = new Date($(this).data('time')).getTime();
                                
                                function updateCountdown() {
                                    const now = new Date().getTime();
                                    const distance = endTime - now;
                                    
                                    if (distance < 0) {
                                        clearInterval(countdownInterval);
                                        $(this).html('<span>Expired</span>');
                                        return;
                                    }
                                    
                                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                                    
                                    $(this).find('.days').text(days.toString().padStart(2, '0'));
                                    $(this).find('.hours').text(hours.toString().padStart(2, '0'));
                                    $(this).find('.minutes').text(minutes.toString().padStart(2, '0'));
                                    $(this).find('.seconds').text(seconds.toString().padStart(2, '0'));
                                }
                                
                                updateCountdown.call(this);
                                const countdownInterval = setInterval(updateCountdown.bind(this), 1000);
                            });
                        }
                        
                        // CRITICAL FIX: Reinitialize lazy loading for new images
                        if (window.lazyLoader) {
                            // Update the images collection with newly added images
                            window.lazyLoader.images = document.querySelectorAll('.lazy-image:not(.loaded)');
                            
                            // Re-initialize the observer for new images
                            if ('IntersectionObserver' in window) {
                                const imageObserver = new IntersectionObserver((entries, observer) => {
                                    entries.forEach(entry => {
                                        if (entry.isIntersecting) {
                                            const img = entry.target;
                                            window.lazyLoader.loadImage(img);
                                            observer.unobserve(img);
                                        }
                                    });
                                });
                                
                                window.lazyLoader.images.forEach(img => imageObserver.observe(img));
                            } else {
                                // Fallback: load all images immediately
                                window.lazyLoader.images.forEach(img => window.lazyLoader.loadImage(img));
                            }
                        } else {
                            // If lazyLoader doesn't exist for some reason, create it
                            window.lazyLoader = new LazyImageLoader();
                        }
                        
                        // Also trigger a manual load for images that might already be in viewport
                        setTimeout(() => {
                            const visibleImages = document.querySelectorAll('.lazy-image:not(.loaded)');
                            visibleImages.forEach(img => {
                                const rect = img.getBoundingClientRect();
                                if (rect.top < window.innerHeight && rect.bottom > 0) {
                                    if (window.lazyLoader && window.lazyLoader.loadImage) {
                                        window.lazyLoader.loadImage(img);
                                    } else {
                                        // Fallback direct loading
                                        const src = img.dataset.src;
                                        if (src) {
                                            img.src = src;
                                            img.classList.add('loaded');
                                        }
                                    }
                                }
                            });
                        }, 200);
                        
                    }, 100);
                }
                
                this.isLoading = false;
                document.getElementById('loading-spinner').classList.remove('active');
            })
            .catch(error => {
                console.error('Error loading section:', error);
                this.isLoading = false;
                document.getElementById('loading-spinner').classList.remove('active');
            });
    }
    
    loadAllSections() {
        this.sectionsToLoad.forEach(section => {
            this.loadSection(section.placeholder);
        });
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize lazy image loader
    window.lazyLoader = new LazyImageLoader();
    
    // Initialize progressive loader
    window.progressiveLoader = new ProgressiveLoader();
    
    // Initialize Owl Carousels for static content (exactly as your original)
    if (typeof $ !== 'undefined') {
        $(document).ready(function() {
            $('.owl-slider').each(function() {
                if (!$(this).hasClass('owl-loaded')) {
                    $(this).owlCarousel({
                        loop: $(this).data('owl-loop') || false,
                        margin: $(this).data('owl-gap') || 0,
                        nav: $(this).data('owl-nav') || false,
                        dots: $(this).data('owl-dots') || false,
                        autoplay: $(this).data('owl-auto') || false,
                        autoplayTimeout: $(this).data('owl-speed') || 5000,
                        responsive: {
                            0: { items: $(this).data('owl-item-xs') || 1 },
                            576: { items: $(this).data('owl-item-sm') || 2 },
                            768: { items: $(this).data('owl-item-md') || 3 },
                            992: { items: $(this).data('owl-item-lg') || 4 },
                            1200: { items: $(this).data('owl-item-xl') || 5 }
                        }
                    });
                }
            });
            
            // Initialize countdown timers
            $('.ps-countdown').each(function() {
                const endTime = new Date($(this).data('time')).getTime();
                
                function updateCountdown() {
                    const now = new Date().getTime();
                    const distance = endTime - now;
                    
                    if (distance < 0) {
                        clearInterval(countdownInterval);
                        $(this).html('<span>Expired</span>');
                        return;
                    }
                    
                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    
                    $(this).find('.days').text(days.toString().padStart(2, '0'));
                    $(this).find('.hours').text(hours.toString().padStart(2, '0'));
                    $(this).find('.minutes').text(minutes.toString().padStart(2, '0'));
                    $(this).find('.seconds').text(seconds.toString().padStart(2, '0'));
                }
                
                updateCountdown.call(this);
                const countdownInterval = setInterval(updateCountdown.bind(this), 1000);
            });
        });
    }
});

// Error handling
window.addEventListener('error', function(e) {
    console.error('JavaScript Error:', e.error);
});
</script>
{% endblock %}