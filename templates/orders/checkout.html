{% extends 'base.html' %}
{% load static %}
{% block title %} Checkout - GenialTouch{% endblock %}
{% block extra_css %}
<style>

    /* Add new styles for birth date fields */
    .birthday-section {
        margin: 20px 0;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 8px;
        border-left: 4px solid #fcb800;
    }
    
    .birthday-label {
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 10px;
        display: block;
    }
    
    .birthday-note {
        font-size: 13px;
        color: #7f8c8d;
        font-style: italic;
        margin-top: 5px;
    }
    


    /* Base Styles */
    .ps-checkout {
        padding: 40px 0;
    }
    
    .ps-form--checkout {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        padding: 30px;
    }
    
    .ps-form__heading {
        font-size: 20px;
        color: #2c3e50;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-control {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 15px;
        transition: all 0.3s;
    }
    
    .form-control:focus {
        border-color: #fcb800;
        box-shadow: 0 0 0 3px rgba(252, 184, 0, 0.2);
    }
    
    .form-control::placeholder {
        color: #999;
    }
    
    textarea.form-control {
        min-height: 100px;
        resize: vertical;
    }
    
    label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2c3e50;
    }
    
    .required-field::after {
        content: ' *';
        color: #dc3545;
    }
    
    /* Order Summary */
    .ps-block--checkout-order {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.03);
        position: sticky;
        top: 20px;
    }
    
    .ps-block--checkout-order figure {
        margin: 0;
        padding: 15px 0;
        border-bottom: 1px solid #eee;
    }
    
    .ps-block--checkout-order figure figcaption {
        display: flex;
        justify-content: space-between;
        font-weight: 700;
    }
    
    .ps-block--checkout-order figure.ps-block__items a {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        color: #2c3e50;
        text-decoration: none;
    }
    
    .ps-block--checkout-order figure.ps-block__items a:last-child {
        margin-bottom: 0;
    }
    
    .ps-block--checkout-order figure.ps-block__items a small {
        color: #fcb800;
        font-weight: 700;
    }
    
    /* Payment Methods */
    .payment-method {
        margin: 25px 0;
    }
    
    .payment-method h3 {
        margin-bottom: 15px;
    }
    
    .payment-option {
        display: flex;
        align-items: flex-start;
        padding: 15px;
        margin-bottom: 10px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .payment-option:hover {
        border-color: #fcb800;
    }
    
    .payment-option input[type="radio"] {
        margin-right: 15px;
        margin-top: 3px;
    }
    
    .payment-content {
        flex-grow: 1;
    }
    
    .payment-title {
        font-weight: 600;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
    }
    
    .payment-description {
        font-size: 14px;
        color: #7f8c8d;
        line-height: 1.5;
    }
    
    .payment-icon {
        width: 30px;
        margin-right: 10px;
    }
    
    /* Tax Display */
    .tax-display {
        display: none;
    }
    
    .tax-display.active {
        display: block;
    }
    
    /* Submit Button */
    .ps-btn--checkout {
        width: 100%;
        padding: 15px;
        font-size: 16px;
        font-weight: 600;
        background: linear-gradient(90deg, #fcb800, #ff6b6b);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 10px;
    }
    
    .ps-btn--checkout:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(252, 184, 0, 0.3);
    }
    
    .ps-btn--checkout:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    /* Shipping Display */
    .shipping-info {
        background: #e8f5e9;
        padding: 10px 15px;
        border-radius: 8px;
        margin: 10px 0;
        font-size: 14px;
    }
    
    .shipping-info .price {
        font-weight: 700;
        color: #2e7d32;
    }
    
    /* Location Select */
    .location-select {
        margin-bottom: 15px;
    }
    
    .location-select select {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 15px;
        background-color: white;
    }
    
    .location-select label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
    }
    
    /* Form Validation */
    .is-invalid {
        border-color: #dc3545;
    }
    
    .invalid-feedback {
        color: #dc3545;
        font-size: 14px;
        margin-top: 5px;
        display: none;
    }
    
    .is-invalid + .invalid-feedback {
        display: block;
    }
    
    /* Responsive */
    @media (max-width: 767px) {
        .ps-form--checkout {
            padding: 20px;
        }
        
        .ps-form__heading {
            font-size: 18px;
        }
        
        .ps-block--checkout-order {
            position: static;
            margin-top: 30px;
        }
        
        .payment-option {
            flex-direction: column;
        }
        
        .payment-option input[type="radio"] {
            margin-bottom: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<main class="ps-page--my-account">
    <div class="ps-breadcrumb">
        <div class="container">
            <ul class="breadcrumb">
                <li><a href="/">Home</a></li>
                <li>Checkout</li>
            </ul>
        </div>
    </div>
    <section class="ps-section--account ps-checkout">
        <div class="container">
            <div class="ps-section__header">
                <h3>Checkout Information</h3>
            </div>
            <div class="ps-section__content">
                <form class="ps-form--checkout" id="checkout-form" method="post">
                    {% csrf_token %}
                    <div class="ps-form__content">
                        <div class="row">
                            <div class="col-xl-8 col-lg-8 col-md-12 col-sm-12 col-12">
                                <div class="ps-form__billing-info">
                                    <h3 class="ps-form__heading">Contact Information</h3>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="required-field">First Name</label>
                                                <input class="form-control" type="text" name="first_name" 
                                                       value="{{ initial_data.first_name|default:'' }}" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="required-field">Last Name</label>
                                                <input class="form-control" type="text" name="last_name" 
                                                       value="{{ initial_data.last_name|default:'' }}" required>
                                            </div>
                                        </div>
                                    </div>


                                    <!-- Add Birthday Section -->
                                    <!-- <div class="birthday-section">
                                        <span class="birthday-label">Birthday Information (Optional)</span>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label>Birth Date</label>
                                                    <input class="form-control" type="date" name="birth_date" 
                                                           max="{{ today }}" id="birth_date">
                                                    <small class="birthday-note">We might send you birthday surprises!</small>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label>Birth Month</label>
                                                    <select class="form-control" name="birth_month" id="birth_month">
                                                        <option value="">Select Month</option>
                                                        <option value="January">January</option>
                                                        <option value="February">February</option>
                                                        <option value="March">March</option>
                                                        <option value="April">April</option>
                                                        <option value="May">May</option>
                                                        <option value="June">June</option>
                                                        <option value="July">July</option>
                                                        <option value="August">August</option>
                                                        <option value="September">September</option>
                                                        <option value="October">October</option>
                                                        <option value="November">November</option>
                                                        <option value="December">December</option>
                                                    </select>
                                                    <small class="birthday-note">Select your birth month</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div> -->

                                    <!-- Add Birthday Section -->
                                    <div class="birthday-section">
                                        <span class="birthday-label">Birthday Information (Optional)</span>
                                        <small class="birthday-note">We might send you birthday surprises!</small>
                                        
                                        <div class="row mt-2">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label>Birth Date</label>
                                                    <select class="form-control" name="birth_date" id="birth_date">
                                                        <option value="">Select Date</option>
                                                        {% for day in days_range %}
                                                            <option value="{{ day }}">{{ day }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label>Birth Month</label>
                                                    <select class="form-control" name="birth_month" id="birth_month">
                                                        <option value="">Select Month</option>
                                                        <option value="January">January</option>
                                                        <option value="February">February</option>
                                                        <option value="March">March</option>
                                                        <option value="April">April</option>
                                                        <option value="May">May</option>
                                                        <option value="June">June</option>
                                                        <option value="July">July</option>
                                                        <option value="August">August</option>
                                                        <option value="September">September</option>
                                                        <option value="October">October</option>
                                                        <option value="November">November</option>
                                                        <option value="December">December</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Email (Optional)</label>
                                        <input class="form-control" type="email" name="email" 
                                               value="{{ initial_data.email|default:'' }}" 
                                               placeholder="Optional - we'll use your account email">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="required-field">Phone Number</label>
                                        <input class="form-control" type="tel" name="phone_number" 
                                               value="{{ initial_data.phone_number|default:'' }}" required>
                                    </div>
                                    
                                    <h3 class="ps-form__heading">Shipping Address</h3>
                                    
                                    <div class="form-group">
                                        <label class="required-field">Full Address</label>
                                        <textarea class="form-control" name="full_address" 
                                                  rows="3" required 
                                                  placeholder="House/Apartment Number, Street, Area, etc."></textarea>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="required-field">Country</label>
                                                <select class="form-control" id="country" name="country" required>
                                                    <option value="">Select Country</option>
                                                    {% for country in countries %}
                                                    <option value="{{ country.id }}">{{ country.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="required-field">District</label>
                                                <select class="form-control" id="district" name="district" required>
                                                    <option value="">Select District</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Thana (Optional)</label>
                                                <select class="form-control" id="thana" name="thana">
                                                    <option value="">Select Thana</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Postal Code (Optional)</label>
                                                <input class="form-control" type="text" name="postal_code" 
                                                       placeholder="Enter postal code if available">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Order Notes (Optional)</label>
                                        <textarea class="form-control" name="order_note" rows="4" 
                                                  placeholder="Any special instructions for delivery"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 col-12">
                                <div class="ps-block--checkout-order">
                                    <div class="ps-block__content">
                                        <figure>
                                            <figcaption><strong>Product</strong><strong>Total</strong></figcaption>
                                        </figure>
                                        <figure class="ps-block__items">
                                            {% for item in cart_items %}
                                            <div class="cart-item">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>{{ item.product.name }}</strong>
                                                        {% if item.variation %}
                                                        <br><small class="text-muted">{{ item.variation.get_variation_name }}</small>
                                                        {% endif %}
                                                    </div>
                                                    <div class="text-right">
                                                        <div>x{{ item.quantity }}</div>
                                                        <small>৳{{ item.total|floatformat:2 }}</small>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </figure>
                                        <figure>
                                            <figcaption>
                                                <strong>Subtotal</strong>
                                                <strong>৳{{ cart_total|floatformat:2 }}</strong>
                                            </figcaption>
                                        </figure>

                                        <figure class="shipping-info" id="shipping-display">
                                            <figcaption>
                                                <strong>Shipping: </strong>
                                                <strong class="price" id="shipping-cost"> (Select district to calculate shipping)</strong>
                                            </figcaption>
                                        </figure>
                                        
                                        <figure class="tax-display" id="tax-display">
                                            <figcaption>
                                                <span id="tax-name">Tax</span>
                                                <strong id="tax-amount">৳0.00</strong>
                                            </figcaption>
                                        </figure>
                                        
                                        <figure>
                                            <figcaption>
                                                <strong>Total</strong>
                                                <strong id="grand-total">৳{{ cart_total|floatformat:2 }}</strong>
                                            </figcaption>
                                        </figure>
                                        
                                        <div class="payment-method">
                                            <h3>Payment Method</h3>
                                            
                                            {% for method in payment_methods %}
                                            <div class="payment-option">
                                                <input type="radio" id="payment-{{ method.id }}" name="payment_method" 
                                                       value="{{ method.id }}" {% if forloop.first %}checked{% endif %} required>
                                                <div class="payment-content">
                                                    <div class="payment-title">
                                                        {% if method.icon %}
                                                        <img src="{{ method.icon.url }}" alt="{{ method.name }}" class="payment-icon">
                                                        {% endif %}
                                                        {{ method.name }}
                                                    </div>
                                                    <div class="payment-description">{{ method.description }}</div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        
                                        <button type="submit" class="ps-btn--checkout" id="submit-order">
                                            Place Order
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </section>
</main>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {


        // Set max date for birth date field
        var today = new Date().toISOString().split('T')[0];
        $('#birth_date').attr('max', today);
        
        // Auto-fill month when date is selected
        $('#birth_date').change(function() {
            if ($(this).val()) {
                var selectedDate = new Date($(this).val());
                var monthNames = [
                    "January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"
                ];
                var monthName = monthNames[selectedDate.getMonth()];
                $('#birth_month').val(monthName);
            }
        });
        
        // Auto-fill date when month is selected (set to 1st of month)
        $('#birth_month').change(function() {
            if ($(this).val() && !$('#birth_date').val()) {
                var monthNames = [
                    "January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"
                ];
                var monthIndex = monthNames.indexOf($(this).val());
                if (monthIndex !== -1) {
                    var currentYear = new Date().getFullYear();
                    var date = new Date(currentYear, monthIndex, 1);
                    var dateString = date.getFullYear() + '-' + 
                                    String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                                    String(date.getDate()).padStart(2, '0');
                    $('#birth_date').val(dateString);
                }
            }
        });


        // Country change handler
        $('#country').change(function() {
            const countryId = $(this).val();
            
            // Reset district and thana
            $('#district').html('<option value="">Select District</option>');
            $('#thana').html('<option value="">Select Thana</option>');
            
            // Load districts for selected country
            if (countryId) {
                $.get('{% url "get_districts" %}', {country_id: countryId}, function(data) {
                    $.each(data, function(i, district) {
                        console.log(district);
                        $('#district').append($('<option>', {
                            value: district.id,
                            text: district.name,
                            'data-shipping-cost': district.shipping_cost
                        }));
                    });
                }).fail(function() {
                    alert('Error loading districts. Please try again.');
                });
            }
            
            // Reset shipping and tax display
            resetOrderSummary();
        });
        
        // District change handler
        $('#district').change(function() {
            const districtId = $(this).val();
            const shippingCost = $(this).find('option:selected').data('shipping-cost') || 0;
            console.log(shippingCost);
            
            // Reset thana
            $('#thana').html('<option value="">Select Thana</option>');
            
            // Load thanas for selected district
            if (districtId) {
                $.get('{% url "get_thanas" %}', {district_id: districtId}, function(data) {
                    $.each(data, function(i, thana) {
                        $('#thana').append($('<option>', {
                            value: thana.id,
                            text: thana.name
                        }));
                    });
                }).fail(function() {
                    alert('Error loading thanas. Please try again.');
                });
            }
            
            // Update shipping display
            updateShippingDisplay(districtId, shippingCost);
            
            // Calculate tax if we have both country and district
            const countryId = $('#country').val();
            if (countryId && districtId) {
                calculateTaxAndTotal(countryId, districtId, shippingCost);
            } else {
                resetOrderSummary();
            }
        });
        
        // Thana change handler (optional, no calculation needed)
        $('#thana').change(function() {
            // You can add any thana-specific logic here if needed
        });
        
        // Function to reset order summary
        function resetOrderSummary() {
            const cartTotal = parseFloat('{{ cart_total }}');
            $('#shipping-cost').text(' (Select district to calculate shipping)');
            $('#tax-display').hide();
            $('#grand-total').text('৳' + cartTotal.toFixed(2));
        }
        
        // Function to update shipping display
        function updateShippingDisplay(districtId, shippingCost) {
            if (districtId) {
                $('#shipping-cost').text('৳' + parseFloat(shippingCost).toFixed(2));
            } else {
                $('#shipping-cost').text(' (Select district to calculate shipping)');
            }
        }
        
        // Function to calculate tax and total
        function calculateTaxAndTotal(countryId, districtId, shippingCost) {
            const cartTotal = parseFloat('{{ cart_total }}');
            
            $.get('{% url "calculate_tax" %}', {
                country_id: countryId,
                district_id: districtId,
                subtotal: cartTotal,
                shipping: shippingCost
            }, function(data) {
                if (data.status === 'success') {

                    console.log(data);

                    // Update shipping cost (in case it's different from the district's default)
                    $('#shipping-cost').text('৳' + data.shipping_cost);
                    
                    // Update tax display
                    if (parseFloat(data.tax_rate) > 0) {
                        $('#tax-name').text(data.tax_name + ' (' + data.tax_rate + '%)');
                        $('#tax-amount').text('৳' + data.tax_amount);
                        $('#tax-display').show();
                    } else {
                        $('#tax-display').hide();
                    }
                    
                    // Update grand total
                    $('#grand-total').text('৳' + data.grand_total);
                }
            }).fail(function() {
                alert('Error calculating tax. Please try again.');
            });
        }
        
        // Form validation
        $('#checkout-form').submit(function(e) {
            // Basic validation
            const country = $('#country').val();
            const district = $('#district').val();
            
            if (!country || !district) {
                e.preventDefault();
                alert('Please select both country and district.');
                return false;
            }
            
            // Disable submit button
            $('#submit-order').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Placing Order...');
        });
        
        // Real-time form validation
        $('input[required], select[required]').on('blur', function() {
            if (!$(this).val()) {
                $(this).addClass('is-invalid');
            } else {
                $(this).removeClass('is-invalid');
            }
        });
    });
</script>


<!-- GA4 Checkout Tracking -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Prepare cart items data for GA4
        var cartItems = [
            {% for item in cart_items %}
            {
                'item_id': '{{ item.product.id }}',
                'item_name': '{{ item.product.name|escapejs }}',
                'item_brand': '{{ item.product.brand.name|default:"Unknown"|escapejs }}',
                'item_category': '{{ item.product.categories.first.name|default:"Uncategorized"|escapejs }}',
                'price': {{ item.product.get_price|default:item.product.price }},
                'quantity': {{ item.quantity }},
                {% if item.variation %}
                'item_variant': '{{ item.variation.get_variation_name|escapejs }}',
                {% endif %}
                'currency': 'BDT'
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        
        // Calculate cart total
        var cartValue = {{ cart_total|default:0 }};
        
        // Push begin_checkout event to dataLayer
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({
            'event': 'begin_checkout',
            'ecommerce': {
                'currency': 'BDT',
                'value': cartValue,
                'coupon': '', // Add if you have coupon codes
                'items': cartItems
            }
        });
        
        console.log('GA4 begin_checkout tracked:', cartItems.length, 'items');
    });
</script>
{% endblock %}