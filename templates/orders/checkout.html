{% extends 'base.html' %}
{% load static %}
{% block title %} Checkout - GenialTouch{% endblock %}
{% block extra_css %}
<style>
    /* Add new styles for birth date fields */
    .birthday-section {
        margin: 20px 0;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 8px;
        border-left: 4px solid #fcb800;
    }
    
    .birthday-label {
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 10px;
        display: block;
    }
    
    .birthday-note {
        font-size: 13px;
        color: #7f8c8d;
        font-style: italic;
        margin-top: 5px;
    }
    
    /* Promo Code Styles */
    .promo-code-section {
        margin: 20px 0;
        padding: 15px;
        background: #f0f8ff;
        border-radius: 8px;
        border: 1px dashed #fcb800;
    }
    
    .promo-code-section h4 {
        margin-bottom: 10px;
        color: #2c3e50;
        font-size: 16px;
    }
    
    .input-group {
        display: flex;
        margin-bottom: 5px;
    }
    
    .input-group .form-control {
        flex: 1;
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }
    
    .input-group-append {
        margin-left: -1px;
    }
    
    .input-group-append .btn {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        background: #fcb800;
        color: white;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .input-group-append .btn:hover {
        background: #e5a600;
    }
    
    .input-group-append .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .btn-link {
        background: none;
        border: none;
        color: #fcb800;
        text-decoration: underline;
        cursor: pointer;
        padding: 0;
    }
    
    .btn-link:hover {
        color: #e5a600;
    }
    
    .alert {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
    }
    
    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .alert-danger {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .alert-info {
        background: #e7f3ff;
        color: #004085;
        border: 1px solid #b8daff;
    }
    
    .alert-warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
    }
    
    .btn-outline-danger {
        color: #dc3545;
        background: transparent;
        border: 1px solid #dc3545;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }
    
    .btn-outline-danger:hover {
        background: #dc3545;
        color: white;
    }
    
    .text-success {
        color: #28a745;
    }
    
    .text-warning {
        color: #856404;
    }
    
    .progress {
        height: 5px;
        margin-top: 8px;
        background: #cce5ff;
        border-radius: 3px;
        overflow: hidden;
    }
    
    .progress-bar {
        height: 100%;
        background: #28a745;
        transition: width 0.3s ease;
    }

    /* Base Styles */
    .ps-checkout {
        padding: 40px 0;
    }
    
    .ps-form--checkout {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        padding: 30px;
    }
    
    .ps-form__heading {
        font-size: 20px;
        color: #2c3e50;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-control {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 15px;
        transition: all 0.3s;
    }
    
    .form-control:focus {
        border-color: #fcb800;
        box-shadow: 0 0 0 3px rgba(252, 184, 0, 0.2);
    }
    
    .form-control::placeholder {
        color: #999;
    }
    
    textarea.form-control {
        min-height: 100px;
        resize: vertical;
    }
    
    label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2c3e50;
    }
    
    .required-field::after {
        content: ' *';
        color: #dc3545;
    }
    
    /* Order Summary */
    .ps-block--checkout-order {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.03);
        position: sticky;
        top: 20px;
    }
    
    .ps-block--checkout-order figure {
        margin: 0;
        padding: 15px 0;
        border-bottom: 1px solid #eee;
    }
    
    .ps-block--checkout-order figure figcaption {
        display: flex;
        justify-content: space-between;
        font-weight: 700;
    }
    
    .ps-block--checkout-order figure.ps-block__items a {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        color: #2c3e50;
        text-decoration: none;
    }
    
    .ps-block--checkout-order figure.ps-block__items a:last-child {
        margin-bottom: 0;
    }
    
    .ps-block--checkout-order figure.ps-block__items a small {
        color: #fcb800;
        font-weight: 700;
    }
    
    .cart-item {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }
    
    .cart-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    
    /* Payment Methods */
    .payment-method {
        margin: 25px 0;
    }
    
    .payment-method h3 {
        margin-bottom: 15px;
    }
    
    .payment-option {
        display: flex;
        align-items: flex-start;
        padding: 15px;
        margin-bottom: 10px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .payment-option:hover {
        border-color: #fcb800;
    }
    
    .payment-option input[type="radio"] {
        margin-right: 15px;
        margin-top: 3px;
    }
    
    .payment-content {
        flex-grow: 1;
    }
    
    .payment-title {
        font-weight: 600;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
    }
    
    .payment-description {
        font-size: 14px;
        color: #7f8c8d;
        line-height: 1.5;
    }
    
    .payment-icon {
        width: 30px;
        margin-right: 10px;
    }
    
    /* Tax Display */
    .tax-display {
        display: none;
    }
    
    .tax-display.active {
        display: block;
    }
    
    /* Submit Button */
    .ps-btn--checkout {
        width: 100%;
        padding: 15px;
        font-size: 16px;
        font-weight: 600;
        background: linear-gradient(90deg, #fcb800, #ff6b6b);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 10px;
    }
    
    .ps-btn--checkout:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(252, 184, 0, 0.3);
    }
    
    .ps-btn--checkout:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    /* Shipping Display */
    .shipping-info {
        background: #e8f5e9;
        padding: 10px 15px;
        border-radius: 8px;
        margin: 10px 0;
        font-size: 14px;
    }
    
    .shipping-info .price {
        font-weight: 700;
        color: #2e7d32;
    }
    
    /* Location Select */
    .location-select {
        margin-bottom: 15px;
    }
    
    .location-select select {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 15px;
        background-color: white;
    }
    
    .location-select label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
    }
    
    /* Form Validation */
    .is-invalid {
        border-color: #dc3545;
    }
    
    .invalid-feedback {
        color: #dc3545;
        font-size: 14px;
        margin-top: 5px;
        display: none;
    }
    
    .is-invalid + .invalid-feedback {
        display: block;
    }
    
    /* Responsive */
    @media (max-width: 767px) {
        .ps-form--checkout {
            padding: 20px;
        }
        
        .ps-form__heading {
            font-size: 18px;
        }
        
        .ps-block--checkout-order {
            position: static;
            margin-top: 30px;
        }
        
        .payment-option {
            flex-direction: column;
        }
        
        .payment-option input[type="radio"] {
            margin-bottom: 10px;
        }
        
        .input-group {
            flex-direction: column;
        }
        
        .input-group .form-control {
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .input-group-append {
            margin-left: 0;
        }
        
        .input-group-append .btn {
            border-radius: 8px;
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<main class="ps-page--my-account">
    <div class="ps-breadcrumb">
        <div class="container">
            <ul class="breadcrumb">
                <li><a href="/">Home</a></li>
                <li>Checkout</li>
            </ul>
        </div>
    </div>
    <section class="ps-section--account ps-checkout">
        <div class="container">
            <div class="ps-section__header">
                <h3>Checkout Information</h3>
            </div>
            <div class="ps-section__content">
                <form class="ps-form--checkout" id="checkout-form" method="post">
                    {% csrf_token %}
                    <div class="ps-form__content">
                        <div class="row">
                            <div class="col-xl-8 col-lg-8 col-md-12 col-sm-12 col-12">
                                <div class="ps-form__billing-info">
                                    <h3 class="ps-form__heading">Contact Information</h3>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="required-field">First Name</label>
                                                <input class="form-control" type="text" name="first_name" 
                                                       value="{{ initial_data.first_name|default:'' }}" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="required-field">Last Name</label>
                                                <input class="form-control" type="text" name="last_name" 
                                                       value="{{ initial_data.last_name|default:'' }}" required>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Birthday Section -->
                                    <div class="birthday-section">
                                        <span class="birthday-label">Birthday Information (Optional)</span>
                                        <small class="birthday-note">We might send you birthday surprises!</small>
                                        
                                        <div class="row mt-2">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label>Birth Date</label>
                                                    <select class="form-control" name="birth_date" id="birth_date">
                                                        <option value="">Select Date</option>
                                                        {% for day in days_range %}
                                                            <option value="{{ day }}">{{ day }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label>Birth Month</label>
                                                    <select class="form-control" name="birth_month" id="birth_month">
                                                        <option value="">Select Month</option>
                                                        <option value="January">January</option>
                                                        <option value="February">February</option>
                                                        <option value="March">March</option>
                                                        <option value="April">April</option>
                                                        <option value="May">May</option>
                                                        <option value="June">June</option>
                                                        <option value="July">July</option>
                                                        <option value="August">August</option>
                                                        <option value="September">September</option>
                                                        <option value="October">October</option>
                                                        <option value="November">November</option>
                                                        <option value="December">December</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Email (Optional)</label>
                                        <input class="form-control" type="email" name="email" 
                                               value="{{ initial_data.email|default:'' }}" 
                                               placeholder="Optional - we'll use your account email if logged in">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="required-field">Phone Number</label>
                                        <input class="form-control" type="tel" name="phone_number" 
                                               value="{{ initial_data.phone_number|default:'' }}" required>
                                    </div>
                                    
                                    <h3 class="ps-form__heading">Shipping Address</h3>
                                    
                                    <div class="form-group">
                                        <label class="required-field">Full Address</label>
                                        <textarea class="form-control" name="full_address" 
                                                  rows="3" required 
                                                  placeholder="House/Apartment Number, Street, Area, etc."></textarea>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="required-field">Country</label>
                                                <select class="form-control" id="country" name="country" required>
                                                    <option value="">Select Country</option>
                                                    {% for country in countries %}
                                                    <option value="{{ country.id }}">{{ country.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="required-field">District</label>
                                                <select class="form-control" id="district" name="district" required>
                                                    <option value="">Select District</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Thana (Optional)</label>
                                                <select class="form-control" id="thana" name="thana">
                                                    <option value="">Select Thana</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Postal Code (Optional)</label>
                                                <input class="form-control" type="text" name="postal_code" 
                                                       placeholder="Enter postal code if available">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Order Notes (Optional)</label>
                                        <textarea class="form-control" name="order_note" rows="4" 
                                                  placeholder="Any special instructions for delivery"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 col-12">
                                <div class="ps-block--checkout-order">
                                    <div class="ps-block__content">
                                        <figure>
                                            <figcaption><strong>Product</strong><strong>Total</strong></figcaption>
                                        </figure>
                                        <figure class="ps-block__items">
                                            {% for item in cart_items %}
                                            <div class="cart-item">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>{{ item.product.name }}</strong>
                                                        {% if item.variation %}
                                                        <br><small class="text-muted">{{ item.variation.get_variation_name }}</small>
                                                        {% endif %}
                                                    </div>
                                                    <div class="text-right">
                                                        <div>x{{ item.quantity }}</div>
                                                        <small>{{ currency_symbol }}{{ item.total|floatformat:2 }}</small>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </figure>
                                        
                                        <!-- Promo Code Section with Minimum Purchase Display -->
                                        <div class="promo-code-section">
                                            <h4>Have a Promo Code?</h4>
                                            
                                            <div id="promo-status" style="display: none;"></div>
                                            
                                            <!-- Minimum Purchase Requirement Info (shown when validating) -->
                                            <div id="promo-requirements" style="display: none; margin-bottom: 10px;">
                                                <div class="alert alert-info">
                                                    <span id="promo-requirements-message"></span>
                                                    <div class="progress">
                                                        <div id="promo-progress-bar" class="progress-bar" style="width: 0%;"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div id="promo-input-group" {% if applied_promo %}style="display: none;"{% endif %}>
                                                <div class="input-group">
                                                    <input type="text" id="promo-code-input" class="form-control" 
                                                           placeholder="Enter promo code" value="">
                                                    <div class="input-group-append">
                                                        <button type="button" id="apply-promo-btn" class="btn">
                                                            Apply
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center mt-2">
                                                    <small class="form-text text-muted">Enter your promo code to get discount</small>
                                                    <button type="button" id="validate-promo-btn" class="btn btn-sm btn-link">
                                                        Check
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div id="applied-promo-info" {% if not applied_promo %}style="display: none;"{% endif %}>
                                                {% if applied_promo %}
                                                <div class="alert alert-success">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <strong>Promo Applied: {{ applied_promo.code }}</strong><br>
                                                            <small>You saved: {{ currency_symbol }}{{ promo_discount|floatformat:2 }}</small>
                                                            {% if applied_promo.minimum_purchase_amount > cart_total %}
                                                            <div class="text-warning mt-1">
                                                                <small>⚠️ Warning: Your cart total is below the minimum purchase requirement</small>
                                                            </div>
                                                            {% endif %}
                                                        </div>
                                                        <button type="button" id="remove-promo-btn" class="btn btn-outline-danger btn-sm">
                                                            Remove
                                                        </button>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <figure>
                                            <figcaption>
                                                <strong>Subtotal</strong>
                                                <strong>{{ currency_symbol }}{{ cart_total|floatformat:2 }}</strong>
                                            </figcaption>
                                        </figure>
                                        
                                        {% if applied_promo %}
                                        <figure>
                                            <figcaption>
                                                <strong>Promo Discount ({{ applied_promo.code }})</strong>
                                                <strong class="text-success">-{{ currency_symbol }}{{ promo_discount|floatformat:2 }}</strong>
                                            </figcaption>
                                        </figure>
                                        {% endif %}
                                        
                                        <figure class="shipping-info" id="shipping-display">
                                            <figcaption>
                                                <strong>Shipping: </strong>
                                                <strong class="price" id="shipping-cost">(Select district to calculate shipping)</strong>
                                            </figcaption>
                                        </figure>
                                        
                                        <figure class="tax-display" id="tax-display">
                                            <figcaption>
                                                <span id="tax-name">Tax</span>
                                                <strong id="tax-amount">{{ currency_symbol }}0.00</strong>
                                            </figcaption>
                                        </figure>
                                        
                                        <figure>
                                            <figcaption>
                                                <strong>Total</strong>
                                                <strong id="grand-total">{{ currency_symbol }}{{ display_cart_total|floatformat:2 }}</strong>
                                            </figcaption>
                                        </figure>
                                        
                                        <div class="payment-method">
                                            <h3>Payment Method</h3>
                                            
                                            {% for method in payment_methods %}
                                            <div class="payment-option">
                                                <input type="radio" id="payment-{{ method.id }}" name="payment_method" 
                                                       value="{{ method.id }}" {% if forloop.first %}checked{% endif %} required>
                                                <div class="payment-content">
                                                    <div class="payment-title">
                                                        {% if method.icon %}
                                                        <img src="{{ method.icon.url }}" alt="{{ method.name }}" class="payment-icon">
                                                        {% endif %}
                                                        {{ method.name }}
                                                    </div>
                                                    <div class="payment-description">{{ method.description }}</div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        
                                        <button type="submit" class="ps-btn--checkout" id="submit-order">
                                            Place Order
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </section>
</main>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        // Set max date for birth date field
        var today = new Date().toISOString().split('T')[0];
        $('#birth_date').attr('max', today);
        
        // Country change handler
        $('#country').change(function() {
            const countryId = $(this).val();
            
            // Reset district and thana
            $('#district').html('<option value="">Select District</option>');
            $('#thana').html('<option value="">Select Thana</option>');
            
            // Load districts for selected country
            if (countryId) {
                $.get('{% url "get_districts" %}', {country_id: countryId}, function(data) {
                    $.each(data, function(i, district) {
                        $('#district').append($('<option>', {
                            value: district.id,
                            text: district.name,
                            'data-shipping-cost': district.shipping_cost
                        }));
                    });
                }).fail(function() {
                    alert('Error loading districts. Please try again.');
                });
            }
            
            // Reset shipping and tax display
            resetOrderSummary();
        });
        
        // District change handler
        $('#district').change(function() {
            const districtId = $(this).val();
            const selectedOption = $(this).find('option:selected');
            const shippingCost = selectedOption.data('shipping-cost') || 0;
            
            // Reset thana
            $('#thana').html('<option value="">Select Thana</option>');
            
            // Load thanas for selected district
            if (districtId) {
                $.get('{% url "get_thanas" %}', {district_id: districtId}, function(data) {
                    $.each(data, function(i, thana) {
                        $('#thana').append($('<option>', {
                            value: thana.id,
                            text: thana.name
                        }));
                    });
                }).fail(function() {
                    alert('Error loading thanas. Please try again.');
                });
            }
            
            // Update shipping display
            updateShippingDisplay(districtId, shippingCost);
            
            // Calculate tax if we have both country and district
            const countryId = $('#country').val();
            if (countryId && districtId) {
                calculateTaxAndTotal(countryId, districtId, shippingCost);
            } else {
                resetOrderSummary();
            }
        });
        
        // Function to reset order summary
        function resetOrderSummary() {
            const cartTotal = parseFloat('{{ cart_total }}');
            const promoDiscount = parseFloat('{{ promo_discount|default:0 }}');
            const displayTotal = cartTotal - promoDiscount;
            
            $('#shipping-cost').text('(Select district to calculate shipping)');
            $('#tax-display').hide();
            $('#grand-total').text('{{ currency_symbol }}' + displayTotal.toFixed(2));
        }
        
        // Function to update shipping display
        function updateShippingDisplay(districtId, shippingCost) {
            if (districtId) {
                $('#shipping-cost').text('{{ currency_symbol }}' + parseFloat(shippingCost).toFixed(2));
            } else {
                $('#shipping-cost').text('(Select district to calculate shipping)');
            }
        }
        
        // Function to calculate tax and total
        function calculateTaxAndTotal(countryId, districtId, shippingCost) {
            const cartTotal = parseFloat('{{ cart_total }}');
            const promoDiscount = parseFloat('{{ promo_discount|default:0 }}');
            const subtotalAfterPromo = cartTotal - promoDiscount;
            
            $.get('{% url "calculate_tax" %}', {
                country_id: countryId,
                district_id: districtId,
                subtotal: subtotalAfterPromo,
                shipping: shippingCost
            }, function(data) {
                if (data.status === 'success') {
                    // Update shipping cost
                    $('#shipping-cost').text('{{ currency_symbol }}' + data.shipping_cost);
                    
                    // Update tax display
                    if (parseFloat(data.tax_rate) > 0) {
                        $('#tax-name').text(data.tax_name + ' (' + data.tax_rate + '%)');
                        $('#tax-amount').text('{{ currency_symbol }}' + data.tax_amount);
                        $('#tax-display').show();
                    } else {
                        $('#tax-display').hide();
                    }
                    
                    // Update grand total
                    $('#grand-total').text('{{ currency_symbol }}' + data.grand_total);
                }
            }).fail(function() {
                alert('Error calculating tax. Please try again.');
            });
        }
        
        // Validate promo code without applying (check button)
        $('#validate-promo-btn').click(function() {
            const promoCode = $('#promo-code-input').val().trim().toUpperCase();
            
            if (!promoCode) {
                showPromoMessage('Please enter a promo code', 'error');
                return;
            }
            
            // Show loading
            $(this).html('<i class="fas fa-spinner fa-spin"></i>');
            
            $.ajax({
                url: '{% url "offer_management:validate_promo" %}',
                method: 'GET',
                data: {
                    code: promoCode
                },
                success: function(response) {
                    if (response.valid) {
                        // Show success message with minimum purchase info
                        let message = response.message;
                        if (!response.meets_minimum) {
                            message = `⚠️ ${response.message}`;
                            showPromoRequirements(response);
                        } else {
                            $('#promo-requirements').hide();
                            showPromoMessage(message, 'success');
                        }
                    } else {
                        $('#promo-requirements').hide();
                        showPromoMessage(response.message, 'error');
                    }
                },
                error: function() {
                    $('#promo-requirements').hide();
                    showPromoMessage('Error validating promo code', 'error');
                },
                complete: function() {
                    $('#validate-promo-btn').html('Check');
                }
            });
        });
        
        // Show minimum purchase requirements
        function showPromoRequirements(response) {
            const percentage = (response.cart_total / response.minimum_purchase) * 100;
            const remaining = response.remaining_amount;
            
            $('#promo-requirements-message').html(`
                <strong>${response.message}</strong><br>
                <small>Current cart: {{ currency_symbol }}${response.cart_total.toFixed(2)} | 
                Required: {{ currency_symbol }}${response.minimum_purchase.toFixed(2)}</small>
            `);
            
            $('#promo-progress-bar').css('width', Math.min(percentage, 100) + '%');
            $('#promo-requirements').show();
        }
        
        // Apply promo code with minimum purchase validation
        $('#apply-promo-btn').click(function() {
            const promoCode = $('#promo-code-input').val().trim().toUpperCase();
            
            if (!promoCode) {
                showPromoMessage('Please enter a promo code', 'error');
                return;
            }
            
            // Disable button and show loading
            $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
            
            $.ajax({
                url: '{% url "offer_management:apply_promo" %}',
                method: 'POST',
                data: {
                    promo_code: promoCode,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.status === 'success') {
                        showPromoMessage(response.message, 'success');
                        
                        // Reload page to reflect changes
                        setTimeout(function() {
                            location.reload();
                        }, 1500);
                        
                    } else {
                        showPromoMessage(response.message, 'error');
                        
                        // If minimum purchase not met, show requirements
                        if (response.message.includes('minimum purchase')) {
                            const cartTotal = response.cart_total || {{ cart_total }};
                            const minPurchase = response.minimum_purchase || 0;
                            const remaining = minPurchase - cartTotal;
                            
                            $('#promo-requirements-message').html(`
                                <strong>${response.message}</strong><br>
                                <small>Add {{ currency_symbol }}${remaining.toFixed(2)} more to your cart</small>
                            `);
                            
                            const percentage = (cartTotal / minPurchase) * 100;
                            $('#promo-progress-bar').css('width', Math.min(percentage, 100) + '%');
                            $('#promo-requirements').show();
                        }
                    }
                },
                error: function(xhr) {
                    let errorMsg = 'Error applying promo code. Please try again.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    showPromoMessage(errorMsg, 'error');
                },
                complete: function() {
                    $('#apply-promo-btn').prop('disabled', false).html('Apply');
                }
            });
        });
        
        // Show promo message function
        function showPromoMessage(message, type) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            $('#promo-status').html(`
                <div class="alert ${alertClass}">
                    ${message}
                </div>
            `).show();
            
            // Auto-hide after 5 seconds for success, keep errors visible longer
            if (type === 'success') {
                setTimeout(function() {
                    $('#promo-status').fadeOut();
                }, 5000);
            }
        }
        
        // Remove promo code
        $('#remove-promo-btn').click(function() {
            $.ajax({
                url: '{% url "offer_management:remove_promo" %}',
                method: 'POST',
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.status === 'success') {
                        // Reload page to reflect changes
                        location.reload();
                    }
                },
                error: function() {
                    alert('Error removing promo code. Please try again.');
                }
            });
        });
        
        // Check if applied promo meets minimum purchase on page load
        {% if applied_promo %}
        const cartTotal = {{ cart_total }};
        const minPurchase = {{ applied_promo.minimum_purchase_amount|default:0 }};
        
        if (cartTotal < minPurchase) {
            $('#promo-requirements').show();
            $('#promo-requirements-message').html(`
                <strong>⚠️ Warning: Your cart total ({{ currency_symbol }}${cartTotal.toFixed(2)}) 
                is below the minimum purchase requirement ({{ currency_symbol }}${minPurchase.toFixed(2)}) 
                for promo code {{ applied_promo.code }}</strong><br>
                <small>The promo code may not be applied at checkout</small>
            `);
            
            const percentage = (cartTotal / minPurchase) * 100;
            $('#promo-progress-bar').css('width', Math.min(percentage, 100) + '%');
        }
        {% endif %}
        
        // Form validation
        $('#checkout-form').submit(function(e) {
            // Basic validation
            const country = $('#country').val();
            const district = $('#district').val();
            
            if (!country || !district) {
                e.preventDefault();
                alert('Please select both country and district.');
                return false;
            }
            
            // Disable submit button
            $('#submit-order').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Placing Order...');
        });
        
        // Real-time form validation
        $('input[required], select[required]').on('blur', function() {
            if (!$(this).val()) {
                $(this).addClass('is-invalid');
            } else {
                $(this).removeClass('is-invalid');
            }
        });
        
        // Trigger district change on page load if district is pre-selected (for form validation errors)
        if ($('#district').val()) {
            $('#district').trigger('change');
        }
    });
</script>

<script>
// GA4 Checkout Tracking
// Remove the DOMContentLoaded wrapper and fix the dataLayer structure
var cartItems = [
    {% for item in cart_items %}
    {
        'item_id': '{{ item.product.id }}',
        'item_name': '{{ item.product.name|escapejs }}',
        'item_brand': '{{ item.product.brand.name|default:"Unknown"|escapejs }}',
        'item_category': '{{ item.product.categories.first.name|default:"Uncategorized"|escapejs }}',
        'price': {{ item.product.get_price|default:item.product.price }},
        'quantity': {{ item.quantity }},
        {% if item.variation %}
        'item_variant': '{{ item.variation.get_variation_name|escapejs }}',
        {% endif %}
        'currency': 'BDT'
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// Push begin_checkout event
dataLayer.push({
    'event': 'begin_checkout',
    'ecommerce': {
        'currency': 'BDT',
        'value': {{ cart_total|default:0 }} - {{ promo_discount|default:0 }},
        'coupon': '{{ applied_promo.code|default:"" }}',
        'items': cartItems
    }
});
</script>
{% endblock %}